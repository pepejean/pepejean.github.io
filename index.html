<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="img/favicon.ico">
<link rel=stylesheet href="cssjs/style.css">
<script src="cssjs/ejh.js"></script>
<script src="cssjs/filtre.js"></script>
</head>
<body>
<header>
<h1>
<a href="#top" id=top1 onclick="filtrer('')"></a>
</h1>
</header>
<main>

<section tabindex="0" id="top">
<nav id=nav>
</nav>
</section>

<section tabindex="0" id="about">
</section>

<div id=placeposts></div>

<section tabindex="0" id="home">
<nav id=nav1>
</nav>
</section>
</main>
<footer>
<small>Un site de ilu.be</small>
<small><a href="#about">About</a></small> 
</footer>

<script>
	
function storeVal(context , key , val) {
	var storage = localStorage.getItem(context);
	var obj = storage ? JSON.parse(storage) || {} : {};
	obj[key] = val;
	localStorage.setItem(context , JSON.stringify(obj));
}

function restoreVal(context , key) {
	var storage = localStorage.getItem(context);
	var obj = storage ? JSON.parse(storage) || {} : {};
	return obj[key];
}

function en(c){var x='charCodeAt',b,e={},f=c.split(""),d=[],a=f[0],g=256;for(b=1;b<f.length;b++)c=f[b],null!=e[a+c]?a+=c:(d.push(1<a.length?e[a]:a[x](0)),e[a+c]=g,g++,a=c);d.push(1<a.length?e[a]:a[x](0));for(b=0;b<d.length;b++)d[b]=String.fromCharCode(d[b]);return d.join("")}
function de(b){var a,e={},d=b.split(""),c=f=d[0],g=[c],h=o=256;for(b=1;b<d.length;b++)a=d[b].charCodeAt(0),a=h>a?d[b]:e[a]?e[a]:f+c,g.push(a),c=a.charAt(0),e[o]=f+c,o++,f=a;return g.join("")}
function compress(s) {return en(unescape(encodeURIComponent((s))))}
function decompress(s) {return decodeURIComponent(escape(de(s)))}

;(async function(){
	var response = await fetch(`infossite.txt` , {cache: "no-cache"});
	var infos = await response.json();
	console.log(JSON.stringify(restoreVal("cuisine" , "infossite")));
	console.log(JSON.stringify(infos));
	let files = [];
	let contents = {};
	let json_contents;
	if (JSON.stringify(restoreVal("cuisine" , "infossite")) != JSON.stringify(infos)) {
		console.log('from fetch');
		if (location.origin.endsWith('.loc')) {
			// site local, index directory
			var response = await fetch('content/');
			var data = await response.text();
			const body = new DOMParser().parseFromString(data, "text/html").body;
			for (let a of body.querySelectorAll('a')) {
				if (a.href.endsWith('.txt')) files.push(a.href.split('/').pop().slice(0 , -4));
			}
		} else {
			// github, voir https://stackoverflow.com/questions/39048654/how-to-enable-directory-indexing-on-github-pages
			var response = await fetch('https://api.github.com/repos/pepejean/pepejean.github.io/contents/content/');
			var data = await response.json();
			 for (let file of data) {
				 if (file.name.endsWith('.txt')) files.push(file.name.slice(0 , -4));
			}
		}

		for (let file of files){
			var response = await fetch(`content/${file}.txt` , {cache: "no-cache"});
			var content = await response.text();
			contents[file] = content;
		}
		
		storeVal("cuisine" , "infossite" , infos);
		storeVal("cuisine" , "files" , files);
		json_contents = JSON.stringify(contents);
		storeVal("cuisine" , "contents" , compress(json_contents));
		storeVal("cuisine" , "L" , json_contents.length);
		console.log(json_contents.length);
	} else {
		console.log('from storage');
		files = restoreVal("cuisine" , "files");
		json_contents = decompress(restoreVal("cuisine" , "contents"));
		console.log(json_contents.length , restoreVal("cuisine" , "L"));
		contents = JSON.parse(json_contents);
	}
	
	let titles = {};
	for (let file of files){
		let content = contents[file];
		titles[file] = content.match(/^#.*$/m)[0].replace(/^#*/ , '').trim()
	}
		
	top1.insertAdjacentHTML('beforeEnd' , infos.site_title);
	document.title = infos.site_title;
	about.innerHTML = infos.site_about;
	
	var lifiles = files.map(file => `<li><a href="#${file}"><span>${titles[file]}</span></a> <span>${file}</span></li>`);
	nav.innerHTML = `<p>Recherche de <input type="text" oninput="filtrer(this.value);"></p>` 
					+ `\n<ul class=toc>\n${lifiles.join('\n')}\n</ul>`;	
	nav1.innerHTML = nav.innerHTML;
	var posts = files.map(file => `\n<section tabindex=0 id="${file}">\n${ejh.easy(contents[file])}\n</section>\n`);
	
	placeposts.outerHTML = posts.join('\n');
	storeVal("cuisine" , "infossite" , infos);
})();	
	
function filtrer(inputstring) {
	document.querySelectorAll('nav p input').forEach(input => {input.value = inputstring});
	lefiltre.init(inputstring);
	window.reg = new RegExp(inputstring , 'i');
	document.querySelectorAll('nav ul.toc li').forEach(li => li.style.display = lefiltre.match(li.textContent) ? '' : 'none')
}
</script>
</body>
</html>
