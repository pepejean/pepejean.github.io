<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="img/favicon.ico">
<link rel=stylesheet href="cssjs/style.css">
<script src="cssjs/ejh.js"></script>
<script src="cssjs/filtre.js"></script>
<script src="cssjs/lz-string.js"></script>
</head>
<body>
<header>
<h1>
<a href="#top" id=top1 onclick="filtrer('')"></a>
</h1>
</header>
<main>

<section tabindex="0" id="top">
<nav id=nav>
</nav>
</section>

<section tabindex="0" id="about">
</section>

<div id=placeposts></div>

<section tabindex="0" id="home">
<nav id=nav1>
</nav>
</section>
</main>
<footer>
<small>Un site de ilu.be</small>
<small><a href="#about">About</a></small> 
</footer>

<script>
	
function storeVal(context , key , val) {
	var storage = localStorage.getItem(context);
	var obj = storage ? JSON.parse(storage) || {} : {};
	obj[key] = val;
	localStorage.setItem(context , JSON.stringify(obj));
}

function restoreVal(context , key) {
	var storage = localStorage.getItem(context);
	var obj = storage ? JSON.parse(storage) || {} : {};
	return obj[key];
}

function decompressme(s){return LZString.decompress(s)}
function encompressme(s){return LZString.compress(s)}
	
;(async function(){
	var response = await fetch(`infossite.txt` , {cache: "no-cache"});
	var infos = await response.json();
	console.log(JSON.stringify(restoreVal("cuisine" , "infossite")));
	console.log(JSON.stringify(infos));
	if (JSON.stringify(restoreVal("cuisine" , "infossite")) != JSON.stringify(infos) || !restoreVal("cuisine" , "bodyhtml")) {
		top1.insertAdjacentHTML('beforeEnd' , infos.site_title);
		document.title = infos.site_title;
		about.innerHTML = infos.site_about;
		
		let files = [];
		if (location.origin.endsWith('.loc')) {
			// site local, index directory
			var response = await fetch('content/');
			var data = await response.text();
			const body = new DOMParser().parseFromString(data, "text/html").body;
			for (let a of body.querySelectorAll('a')) {
				if (a.href.endsWith('.txt')) files.push(a.href.split('/').pop().slice(0 , -4));
			}
		} else {
			// github, voir https://stackoverflow.com/questions/39048654/how-to-enable-directory-indexing-on-github-pages
			var response = await fetch('https://api.github.com/repos/pepejean/pepejean.github.io/contents/content/');
			var data = await response.json();
			 for (let file of data) {
				 if (file.name.endsWith('.txt')) files.push(file.name.slice(0 , -4));
			}
		}
		var contents = {};
		var titles = {};
		for (let file of files){
			var response = await fetch(`content/${file}.txt` , {cache: "no-cache"});
			var content = await response.text();
			contents[file] = content;
			titles[file] = content.match(/^#.*$/m)[0].replace(/^#*/ , '').trim()
		}
		
		var lifiles = files.map(file => `<li><a href="#${file}"><span>${titles[file]}</span></a> <span>${file}</span></li>`);
		nav.innerHTML = `<p>Recherche de <input type="text" oninput="filtrer(this.value);"></p>` 
						+ `\n<ul class=toc>\n${lifiles.join('\n')}\n</ul>`;	
		nav1.innerHTML = nav.innerHTML;
		var posts = files.map(file => `\n<section tabindex=0 id="${file}">\n${ejh.easy(contents[file])}\n</section>\n`);
		
		placeposts.outerHTML = posts.join('\n');
		storeVal("cuisine" , "infossite" , infos);
		storeVal("cuisine" , "bodyhtml" , encompressme(document.body.innerHTML));
		console.log('from fetch');
	} else {
		console.log('from storage');
		document.title = infos.site_title;
		document.body.innerHTML = decompressme(restoreVal("cuisine" , "bodyhtml"));
	}
})();	
	
function filtrer(inputstring) {
	document.querySelectorAll('nav p input').forEach(input => {input.value = inputstring});
	lefiltre.init(inputstring);
	window.reg = new RegExp(inputstring , 'i');
	document.querySelectorAll('nav ul.toc li').forEach(li => li.style.display = lefiltre.match(li.textContent) ? '' : 'none')
}
</script>
</body>
</html>
